{% extends 'base/base.html' %}

{% block title %}Email List - StopSale Automation System{% endblock %}

{% block extra_css %}
<style>
    .email-subject {
        color: #555;
        font-weight: 500;
    }
    .email-table tr {
        transition: all 0.2s ease;
    }
    .email-table tr:hover {
        background-color: rgba(74, 107, 223, 0.05);
    }
    .email-table th {
        background-color: #f1f5ff;
        border-top: 1px solid #d8e2fd;
        border-bottom: 1px solid #d8e2fd;
        color: #516395;
        font-weight: 600;
    }
    .email-card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: none;
    }
    .badge {
        font-weight: 500;
        padding: 0.4em 0.7em;
        border-radius: 6px;
    }
    .badge.bg-pending {
        background-color: #ffb74d;
        color: #904c00;
    }
    .badge.bg-approved {
        background-color: #66bb6a;
        color: #1b5e20;
    }
    .badge.bg-manual {
        background-color: #29b6f6;
        color: #01579b;
    }
    .badge.bg-robot-sent {
        background-color: #7986cb;
        color: #1a237e;
    }
    .badge.bg-robot-processed {
        background-color: #4db6ac;
        color: #004d40;
    }
    .badge.bg-ignored {
        background-color: #bdbdbd;
        color: #424242;
    }
    .badge.bg-error {
        background-color: #ef5350;
        color: #b71c1c;
    }
    .btn-action {
        border-radius: 6px;
        font-weight: 500;
    }
    .action-icons {
        font-size: 0.9rem;
        margin-right: 5px;
    }
    .email-meta {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .pagination .page-link {
        color: #4a6bdf;
        border-color: #d8e2fd;
    }
    .pagination .page-item.active .page-link {
        background-color: #4a6bdf;
        border-color: #4a6bdf;
        color: white;
    }
    .unread-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4a6bdf;
        display: inline-block;
        margin-right: 6px;
        vertical-align: middle;
    }
    .filter-badge {
        background-color: #e3f2fd;
        color: #4a6bdf;
        padding: 0.5em 0.8em;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        margin-right: 0.5rem;
        font-size: 0.85rem;
    }
    .filter-badge .bi-x {
        cursor: pointer;
        margin-left: 5px;
    }
    .info-alert {
        background-color: #e3f2fd;
        border-color: #bbdefb;
        color: #0d47a1;
        border-radius: 8px;
    }
    .btn-delete {
        color: #dc3545; /* Bootstrap danger color */
        border: none;
        background: none;
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
    }
    .btn-delete:hover {
        color: #a71d2a;
        background-color: rgba(220, 53, 69, 0.1);
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h1>E-posta Listesi</h1>
    <div class="d-flex">
        <a href="{% url 'emails:add_manual_rule' %}" class="btn btn-success me-2">
            <i class="bi bi-plus-circle"></i> Manuel Kural Ekle
        </a>
        <form method="get" class="d-flex me-2">
            <div class="input-group">
                <input type="text" name="search" class="form-control" placeholder="E-posta ara..." value="{{ request.GET.search|default:'' }}">
                <button class="btn btn-outline-primary" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle btn-action" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-funnel action-icons"></i> Filtrele
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                <li><h6 class="dropdown-header">Status</h6></li>
                <li><a class="dropdown-item {% if request.GET.status == 'pending' %}active{% endif %}" href="?status=pending{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Bekliyor</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'processing' %}active{% endif %}" href="?status=processing{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">İşleniyor</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'approved' %}active{% endif %}" href="?status=approved{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Onaylandı</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'rejected' %}active{% endif %}" href="?status=rejected{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Reddedildi</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'rejected_hotel_not_found' %}active{% endif %}" href="?status=rejected_hotel_not_found{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">JP Otel Yok</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'blocked_hotel_not_found' %}active{% endif %}" href="?status=blocked_hotel_not_found{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Bloklanmış Oteller</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'rejected_room_not_found' %}active{% endif %}" href="?status=rejected_room_not_found{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">JP Oda Yok</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'sent_to_robot' %}active{% endif %}" href="?status=sent_to_robot{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Robota Gönderildi</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'robot_processed' %}active{% endif %}" href="?status=robot_processed{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Robot İşledi</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'processed_nodata' %}active{% endif %}" href="?status=processed_nodata{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Veri Bulunamadı</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'ignored' %}active{% endif %}" href="?status=ignored{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Yoksayıldı</a></li>
                <li><a class="dropdown-item {% if request.GET.status == 'error' %}active{% endif %}" href="?status=error{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Hata</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item {% if not request.GET.status %}active{% endif %}" href="?{% if request.GET.search %}search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}">Tümü</a></li>
            </ul>
        </div>
        <button class="btn btn-outline-primary ms-2" type="button" data-bs-toggle="modal" data-bs-target="#advancedFilterModal">
            <i class="bi bi-sliders"></i> Gelişmiş Filtre
        </button>
    </div>
</div>

<!-- Active filters display -->
<div class="mb-3">
    {% if request.GET.status or request.GET.search or request.GET.hotel or request.GET.start_date or request.GET.end_date or request.GET.sender or request.GET.rejection_reason or request.GET.match_status or request.GET.has_attachments or request.GET.sort %}
    <div class="active-filters">
        {% if request.GET.status %}
        <span class="filter-badge">
            Durum: 
            {% if request.GET.status == 'pending' %}
                Bekliyor
            {% elif request.GET.status == 'approved' %}
                Onaylandı
            {% elif request.GET.status == 'rejected' %}
                Reddedildi
            {% elif request.GET.status == 'rejected_hotel_not_found' %}
                JP Otel Yok
            {% elif request.GET.status == 'rejected_room_not_found' %}
                JP Oda Yok
            {% elif request.GET.status == 'processing' %}
                İşleniyor
            {% elif request.GET.status == 'sent_to_robot' %}
                Robota Gönderildi
            {% elif request.GET.status == 'robot_processed' %}
                Robot İşledi
            {% elif request.GET.status == 'processed_nodata' %}
                Veri Bulunamadı
            {% elif request.GET.status == 'ignored' %}
                Yoksayıldı
            {% elif request.GET.status == 'error' %}
                Hata
            {% else %}
                {{ request.GET.status|title }}
            {% endif %}
            <a href="?{% if request.GET.search %}search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.sort %}
        <span class="filter-badge">
            Sıralama: 
            {% if request.GET.sort == 'asc' %}
                Eskiden Yeniye
                <i class="bi bi-sort-down-alt ms-1"></i>
            {% elif request.GET.sort == 'desc' %}
                Yeniden Eskiye
                <i class="bi bi-sort-down ms-1"></i>
            {% endif %}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.search %}
        <span class="filter-badge">
            Arama: "{{ request.GET.search }}"
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.sender %}
        <span class="filter-badge">
            Gönderici: "{{ request.GET.sender }}"
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.hotel %}
        <span class="filter-badge">
            Otel: "{{ request.GET.hotel }}"
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.start_date and request.GET.end_date %}
        <span class="filter-badge">
            Tarih: {{ request.GET.start_date }} - {{ request.GET.end_date }}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% elif request.GET.start_date %}
        <span class="filter-badge">
            Başlangıç: {{ request.GET.start_date }}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% elif request.GET.end_date %}
        <span class="filter-badge">
            Bitiş: {{ request.GET.end_date }}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.rejection_reason %}
        <span class="filter-badge">
            Ret Nedeni: 
            {% if request.GET.rejection_reason == 'rejected' %}
                Genel Red
            {% elif request.GET.rejection_reason == 'rejected_hotel_not_found' %}
                JP Otel Yok
            {% elif request.GET.rejection_reason == 'rejected_room_not_found' %}
                JP Oda Yok
            {% else %}
                {{ request.GET.rejection_reason|title }}
            {% endif %}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.match_status %}
        <span class="filter-badge">
            Eşleşme: 
            {% if request.GET.match_status == 'full' %}
                Tam Eşleşme
            {% elif request.GET.match_status == 'partial' %}
                Kısmi Eşleşme
            {% elif request.GET.match_status == 'none' %}
                Eşleşme Yok
            {% else %}
                {{ request.GET.match_status|title }}
            {% endif %}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.has_attachments %}&has_attachments={{ request.GET.has_attachments }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        {% if request.GET.has_attachments %}
        <span class="filter-badge">
            Ekler: 
            {% if request.GET.has_attachments == 'yes' %}
                Eki Olanlar
            {% elif request.GET.has_attachments == 'no' %}
                Eki Olmayanlar
            {% else %}
                {{ request.GET.has_attachments|title }}
            {% endif %}
            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hotel %}&hotel={{ request.GET.hotel }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.sender %}&sender={{ request.GET.sender }}{% endif %}{% if request.GET.rejection_reason %}&rejection_reason={{ request.GET.rejection_reason }}{% endif %}{% if request.GET.match_status %}&match_status={{ request.GET.match_status }}{% endif %}" class="text-decoration-none">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        
        <a href="?" class="btn btn-sm btn-outline-secondary">Tüm Filtreleri Temizle</a>
    </div>
    {% endif %}
</div>

<div class="alert info-alert mb-3" id="autoAnalysisInfo">
    <i class="bi bi-info-circle-fill me-2"></i>
    <span>E-postalar listelenirken, analiz edilmemiş e-postalar otomatik olarak AI ile analiz edilmektedir. Her sayfa yüklemesinde en fazla 5 e-posta analiz edilir.</span>
</div>

<div class="card email-card">
    <div class="card-body p-0">
        <!-- Bulk Actions Bar -->
        <div class="bg-light px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="form-check me-2">
                    <input class="form-check-input" type="checkbox" id="selectAllEmails">
                    <label class="form-check-label" for="selectAllEmails">Tümünü seç</label>
                </div>
                <div class="dropdown ms-2">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="bulkActionDropdown" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                        Seçilenleri İşle
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="bulkActionDropdown">
                        <li><a class="dropdown-item" href="#" id="bulkApprove">Onayla</a></li>
                        <li><a class="dropdown-item" href="#" id="bulkReject">Reddet</a></li>
                        <li><a class="dropdown-item" href="#" id="bulkRejectHotelNotFound">JP Otel Yok</a></li>
                        <li><a class="dropdown-item" href="#" id="bulkRejectRoomNotFound">JP Oda Yok</a></li>
                    </ul>
                </div>
                <span class="ms-3 text-muted" id="selectedCount">0 e-posta seçildi</span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 email-table">
                <thead>
                    <tr>
                        <th style="width: 3%"><div class="form-check m-0"><input type="checkbox" class="form-check-input"></div></th>
                        <th style="width: 32%">Subject</th>
                        <th style="width: 15%">Sender</th>
                        <th style="width: 15%" class="text-nowrap">
                            Received Date
                            <div class="btn-group btn-group-sm ms-2" role="group" aria-label="Date sorting">
                                <a href="?sort=asc{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                   class="btn btn-outline-primary btn-sm{% if sort_order == 'asc' %} active{% endif %}" 
                                   title="Oldest first">
                                    <i class="bi bi-sort-down-alt"></i>
                                </a>
                                <a href="?sort=desc{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                   class="btn btn-outline-primary btn-sm{% if sort_order == 'desc' %} active{% endif %}" 
                                   title="Newest first">
                                    <i class="bi bi-sort-down"></i>
                                </a>
                            </div>
                        </th>
                        <th style="width: 10%">Status</th>
                        <th style="width: 10%">Eşleşme</th>
                        <th style="width: 5%">Attachments</th>
                        <th style="width: 10%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in page_obj %}
                    <tr id="email-row-{{ email.id }}">
                        <td>
                            <div class="form-check m-0">
                                <input type="checkbox" class="form-check-input">
                            </div>
                        </td>
                        <td>
                            {% if email.status == 'pending' %}<span class="unread-indicator"></span>{% endif %}
                            <a href="{% url 'emails:email_detail' email.id %}" class="email-subject text-decoration-none">{{ email.subject }}</a>
                        </td>
                        <td class="email-meta">{{ email.sender }}</td>
                        <td class="email-meta">{{ email.received_date|date:"d M Y H:i" }}</td>
                        <td>
                            {# Dynamic badge based on status #}
                            {% if email.status == 'pending' %}
                                <span class="badge bg-warning">{{ email.get_status_display }}</span>
                            {% elif email.status == 'approved' %}
                                <span class="badge bg-success">{{ email.get_status_display }}</span>
                            {% elif email.status == 'rejected' or email.status == 'rejected_hotel_not_found' or email.status == 'rejected_room_not_found' %}
                                <span class="badge bg-danger">
                                    {% if email.status == 'rejected_hotel_not_found' %}
                                        JP Otel Yok
                                    {% elif email.status == 'rejected_room_not_found' %}
                                        JP Oda Yok
                                    {% else %}
                                        Rejected
                                    {% endif %}
                                </span>
                            {% elif email.status == 'blocked_hotel_not_found' %}
                                <span class="badge bg-dark">
                                    <i class="bi bi-shield-x me-1"></i> Bloklandı
                                </span>
                            {% elif email.status == 'sent_to_robot' %}
                                <span class="badge bg-info">{{ email.get_status_display }}</span>
                            {% elif email.status == 'robot_processed' %}
                                <span class="badge bg-secondary">{{ email.get_status_display }}</span>
                             {% elif email.status == 'processing' %} {# ADDED: Handle processing status #}
                                 <span class="badge bg-primary">{{ email.get_status_display }}</span>
                             {% elif email.status == 'processed_nodata' %} {# ADDED: Handle processed_nodata #}
                                 <span class="badge bg-light text-dark">{{ email.get_status_display }}</span>
                            {% elif email.status == 'manual_processed' %}
                                <span class="badge bg-success">{{ email.get_status_display }}</span>
                            {% elif email.status == 'juniper_manual' %} {# ADDED: Handle Juniper(M) status #}
                                <span class="badge bg-info">
                                    <i class="bi bi-person-check"></i> {{ email.get_status_display }}
                                </span>
                            {% elif email.status == 'juniper_robot' %} {# ADDED: Handle Juniper(R) status #}
                                <span class="badge bg-info">
                                    <i class="bi bi-robot"></i> {{ email.get_status_display }}
                                </span>
                            {% else %}
                                <span class="badge bg-dark">{{ email.get_status_display|default:email.status }}</span> {# Fallback #}
                            {% endif %}
                        </td>
                        <td class="email-meta">
                            {% if email.total_count > 0 %}
                                <span class="badge bg-{{ email.match_status_color }}">
                                    ({{ email.matched_count }}/{{ email.total_count }})
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    (0/0)
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-center email-meta">
                            {% if email.has_attachments %}
                            <i class="bi bi-paperclip"></i>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'emails:email_detail' email.id %}" class="btn btn-sm btn-outline-primary me-1 btn-action" title="View Details">
                                <i class="bi bi-eye"></i>
                            </a>
                            <!-- Add Delete Button -->
                            <button class="btn btn-sm btn-delete delete-email-btn" 
                                    title="Delete Email"
                                    data-email-id="{{ email.id }}"
                                    data-email-subject="{{ email.subject|escapejs }}">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center p-4">No emails found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#">Previous</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for i in page_obj.paginator.page_range %}
            {% if page_obj.number == i %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
            {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#">{{ i }}</a></li>
            {% elif page_obj.number > 3 and i == 1 %}
                <li class="page-item"><a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#">1</a></li>
                {% if page_obj.number > 4 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
            {% elif page_obj.number < page_obj.paginator.num_pages|add:'-2' and i == page_obj.paginator.num_pages %}
                {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#">{{ page_obj.paginator.num_pages }}</a></li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}#">Next</a></li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Advanced Filter Modal -->
<div class="modal fade" id="advancedFilterModal" tabindex="-1" aria-labelledby="advancedFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="advancedFilterModalLabel">Gelişmiş E-posta Filtreleme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="advancedFilterForm" method="get">
                    <!-- Keep existing filters if any -->
                    {% if request.GET.status %}
                    <input type="hidden" name="status" value="{{ request.GET.status }}">
                    {% endif %}
                    {% if request.GET.search %}
                    <input type="hidden" name="search" value="{{ request.GET.search }}">
                    {% endif %}
                    
                    <!-- Sender Filter -->
                    <div class="mb-3">
                        <label for="senderFilter" class="form-label">Gönderici</label>
                        <input type="text" class="form-control" id="senderFilter" name="sender" 
                               placeholder="Gönderici e-posta adresini girin" value="{{ request.GET.sender|default:'' }}">
                        <div class="form-text">Belirli bir göndericiden gelen e-postaları filtreler</div>
                    </div>
                    
                    <!-- Hotel Filter -->
                    <div class="mb-3">
                        <label for="hotelFilter" class="form-label">Otel Adı</label>
                        <input type="text" class="form-control" id="hotelFilter" name="hotel" 
                               placeholder="Otel adını girin" value="{{ request.GET.hotel|default:'' }}">
                        <div class="form-text">Belirli bir otel adı içeren e-postaları filtreler</div>
                    </div>
                    
                    <!-- Date Range Filter -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDateFilter" class="form-label">Başlangıç Tarihi</label>
                            <input type="date" class="form-control" id="startDateFilter" name="start_date"
                                   value="{{ request.GET.start_date|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDateFilter" class="form-label">Bitiş Tarihi</label>
                            <input type="date" class="form-control" id="endDateFilter" name="end_date"
                                   value="{{ request.GET.end_date|default:'' }}">
                        </div>
                    </div>
                    
                    <!-- Quick Date Filter Buttons -->
                    <div class="mb-3">
                        <label class="form-label">Hızlı Tarih Filtreleri</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary quick-date-btn" 
                                    data-pattern="last3days">Son 3 Gün</button>
                            <button type="button" class="btn btn-sm btn-outline-primary quick-date-btn" 
                                    data-pattern="last7days">Son 7 Gün</button>
                            <button type="button" class="btn btn-sm btn-outline-primary quick-date-btn" 
                                    data-pattern="last14days">Son 14 Gün</button>
                            <button type="button" class="btn btn-sm btn-outline-primary quick-date-btn" 
                                    data-pattern="thismonth">Bu Ay</button>
                        </div>
                        <input type="hidden" id="datePatternInput" name="date_pattern" value="{{ request.GET.date_pattern|default:'' }}">
                    </div>
                    
                    <!-- Date Sort Order -->
                    <div class="mb-3">
                        <label class="form-label">Tarih Sıralaması</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sort" id="sortAsc" 
                                   value="asc" {% if sort_order == 'asc' %}checked{% endif %}>
                            <label class="form-check-label" for="sortAsc">Eskiden Yeniye (En eski en üstte)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sort" id="sortDesc" 
                                   value="desc" {% if sort_order == 'desc' %}checked{% endif %}>
                            <label class="form-check-label" for="sortDesc">Yeniden Eskiye (En yeni en üstte)</label>
                        </div>
                    </div>
                    
                    <!-- Rejection Reason Filter -->
                    <div class="mb-3">
                        <label class="form-label">Ret Nedeni</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="rejection_reason" id="rejectAll" 
                                   value="" {% if not request.GET.rejection_reason %}checked{% endif %}>
                            <label class="form-check-label" for="rejectAll">Tümü</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="rejection_reason" id="rejectGeneral" 
                                   value="rejected" {% if request.GET.rejection_reason == 'rejected' %}checked{% endif %}>
                            <label class="form-check-label" for="rejectGeneral">Genel Red</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="rejection_reason" id="rejectHotelNotFound" 
                                   value="rejected_hotel_not_found" {% if request.GET.rejection_reason == 'rejected_hotel_not_found' %}checked{% endif %}>
                            <label class="form-check-label" for="rejectHotelNotFound">JP Otel Yok</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="rejection_reason" id="rejectRoomNotFound" 
                                   value="rejected_room_not_found" {% if request.GET.rejection_reason == 'rejected_room_not_found' %}checked{% endif %}>
                            <label class="form-check-label" for="rejectRoomNotFound">JP Oda Yok</label>
                        </div>
                    </div>
                    
                    <!-- Match Status Filter -->
                    <div class="mb-3">
                        <label class="form-label">Eşleşme Durumu</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="match_status" id="matchAll" 
                                   value="" {% if not request.GET.match_status %}checked{% endif %}>
                            <label class="form-check-label" for="matchAll">Tümü</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="match_status" id="matchFull" 
                                   value="full" {% if request.GET.match_status == 'full' %}checked{% endif %}>
                            <label class="form-check-label" for="matchFull">Tam Eşleşme</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="match_status" id="matchPartial" 
                                   value="partial" {% if request.GET.match_status == 'partial' %}checked{% endif %}>
                            <label class="form-check-label" for="matchPartial">Kısmi Eşleşme</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="match_status" id="matchNone" 
                                   value="none" {% if request.GET.match_status == 'none' %}checked{% endif %}>
                            <label class="form-check-label" for="matchNone">Eşleşme Yok</label>
                        </div>
                    </div>
                    
                    <!-- Attachment Filter -->
                    <div class="mb-3">
                        <label class="form-label">Ekler</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="has_attachments" id="attachAll" 
                                   value="" {% if not request.GET.has_attachments %}checked{% endif %}>
                            <label class="form-check-label" for="attachAll">Tümü</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="has_attachments" id="attachYes" 
                                   value="yes" {% if request.GET.has_attachments == 'yes' %}checked{% endif %}>
                            <label class="form-check-label" for="attachYes">Eki Olanlar</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="has_attachments" id="attachNo" 
                                   value="no" {% if request.GET.has_attachments == 'no' %}checked{% endif %}>
                            <label class="form-check-label" for="attachNo">Eki Olmayanlar</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('advancedFilterForm').submit();">Filtreleri Uygula</button>
            </div>
            
            <script>
                // Add event listeners to quick date filter buttons
                document.addEventListener('DOMContentLoaded', function() {
                    const quickDateButtons = document.querySelectorAll('.quick-date-btn');
                    const datePatternInput = document.getElementById('datePatternInput');
                    const startDateInput = document.getElementById('startDateFilter');
                    const endDateInput = document.getElementById('endDateFilter');
                    
                    quickDateButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            // Get the date pattern from the button's data attribute
                            const pattern = this.dataset.pattern;
                            
                            // Set the pattern in the hidden input
                            datePatternInput.value = pattern;
                            
                            // Clear the date inputs to avoid conflicts
                            startDateInput.value = '';
                            endDateInput.value = '';
                            
                            // Highlight the selected button
                            quickDateButtons.forEach(btn => {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline-primary');
                            });
                            this.classList.remove('btn-outline-primary');
                            this.classList.add('btn-primary');
                            
                            // Auto-submit the form when a quick filter is selected
                            document.getElementById('advancedFilterForm').submit();
                        });
                    });
                    
                    // Highlight the currently active button if any
                    const currentPattern = datePatternInput.value;
                    if (currentPattern) {
                        const activeButton = document.querySelector(`.quick-date-btn[data-pattern="${currentPattern}"]`);
                        if (activeButton) {
                            activeButton.classList.remove('btn-outline-primary');
                            activeButton.classList.add('btn-primary');
                        }
                    }
                });
            </script>
        </div>
    </div>
</div>

<script>
// Debug etmek için jQuery yüklü mü kontrol edelim
console.log("jQuery loaded:", typeof $ !== 'undefined');
console.log("Bootstrap loaded:", typeof bootstrap !== 'undefined');

document.addEventListener('DOMContentLoaded', function () {
    console.log("DOM fully loaded, initializing email list functions...");
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Tüm e-postaların durumlarını kontrol et
    console.log("Checking status for all emails...");
    
    // Her e-posta satırı için ID'yi ve satırı logla
    const emailRows = document.querySelectorAll('tr[id^="email-row-"]');
    console.log(`Found ${emailRows.length} email rows to process`);
    
    // Bulk selection and actions
    const selectAllCheckbox = document.getElementById('selectAllEmails');
    const emailCheckboxes = document.querySelectorAll('tr[id^="email-row-"] .form-check-input');
    const bulkActionDropdown = document.getElementById('bulkActionDropdown');
    const selectedCountSpan = document.getElementById('selectedCount');
    let selectedCount = 0;
    
    console.log("Elements found:", {
        selectAllCheckbox: selectAllCheckbox,
        emailCheckboxes: emailCheckboxes.length,
        bulkActionDropdown: bulkActionDropdown,
        selectedCountSpan: selectedCountSpan
    });
    
    // Function to update UI based on selection state
    function updateSelectionUI() {
        selectedCount = document.querySelectorAll('tr[id^="email-row-"] .form-check-input:checked').length;
        selectedCountSpan.textContent = selectedCount + ' e-posta seçildi';
        
        // Enable/disable bulk action dropdown
        if (selectedCount > 0) {
            bulkActionDropdown.removeAttribute('disabled');
        } else {
            bulkActionDropdown.setAttribute('disabled', 'disabled');
        }
    }
    
    // Handle "Select All" checkbox
    selectAllCheckbox.addEventListener('change', function() {
        console.log("Select All checkbox changed, checked:", this.checked);
        console.log("Number of checkboxes:", emailCheckboxes.length);
        
        emailCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectionUI();
    });
    
    // Handle individual checkboxes
    emailCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Update "Select All" checkbox state
            selectAllCheckbox.checked = 
                emailCheckboxes.length === 
                document.querySelectorAll('tr[id^="email-row-"] .form-check-input:checked').length;
            
            updateSelectionUI();
        });
    });
    
    // Function to handle bulk actions
    function bulkAction(action) {
        // Get selected email IDs
        const selectedEmailIds = [];
        emailCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const row = checkbox.closest('tr[id^="email-row-"]');
                if (row) {
                    const emailId = row.id.replace('email-row-', '');
                    selectedEmailIds.push(emailId);
                }
            }
        });
        
        // Make sure we have selected emails
        if (selectedEmailIds.length === 0) {
            alert('Lütfen işlem yapmak için en az bir e-posta seçin.');
            return;
        }
        
        // Create form data for the request
        const formData = new FormData();
        formData.append('email_ids', JSON.stringify(selectedEmailIds));
        formData.append('action', action);
        
        // Show loading state
        document.body.style.cursor = 'wait';
        
        // Send the request
        fetch('/emails/bulk-action/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Process response
            if (data.success) {
                // Show success message
                alert(`İşlem başarılı: ${data.message || 'Seçilen e-postalar işlendi.'}`);
                
                // Reload page to reflect changes
                window.location.reload();
            } else {
                // Show error message
                alert(`Hata: ${data.message || 'Bir hata oluştu. Lütfen tekrar deneyin.'}`);
            }
        })
        .catch(error => {
            console.error('Bulk action error:', error);
            alert('İşlem sırasında bir hata oluştu. Lütfen tekrar deneyin.');
        })
        .finally(() => {
            // Reset loading state
            document.body.style.cursor = 'default';
        });
    }
    
    // Set up bulk action handlers
    document.getElementById('bulkApprove').addEventListener('click', function() {
        bulkAction('approve');
    });
    
    document.getElementById('bulkReject').addEventListener('click', function() {
        bulkAction('reject');
    });
    
    document.getElementById('bulkRejectHotelNotFound').addEventListener('click', function() {
        console.log("JP Otel Yok button clicked");
        
        // Tek bir onay mesajı (bloklama seçeneği hakkında bilgi veren)
        if (confirm("Seçilen tüm e-postaları \"JP Otel Yok\" olarak reddetmek istediğinizden emin misiniz?\n\nNot: Bu işlem, e-postaları normal şekilde reddedecektir. Benzer e-postaları gelecekte otomatik olarak 'Juniper Otel Yok' olarak işaretlemek için ayrıca bloklama yapmanız gerekir.")) {
            // Doğrudan reject-hotel-not-found işlemini çalıştır
            bulkAction('reject-hotel-not-found');
        }
    });
    
    document.getElementById('bulkRejectRoomNotFound').addEventListener('click', function() {
        bulkAction('reject-room-not-found');
    });
});
</script>
{% endblock %}
